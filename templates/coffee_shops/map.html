<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dublin Coffee Shop Finder</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Prevent scrollbars on main window */
        }

        .wrapper {
            display: flex;
            height: calc(100vh - 56px); /* Adjusted for the navbar height (56px typical) */
            width: 100%;
        }

        .sidebar {
            flex: 0 0 25%; /* fixed ~25% width */
            max-width: 350px; /* Matched the max-width of the original control-panel */
            background: white;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            position: relative;
            z-index: 1000;
            padding: 20px; /* Matched the original control-panel padding */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Added subtle shadow for visual separation */
        }

        .map-container {
            flex: 1 1 auto;
            position: relative;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        
        .results-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 350px; /* Matched original width */
            max-height: calc(100% - 20px); /* Adjusted for new full-height container */
            overflow-y: auto;
            z-index: 1001; /* Higher z-index than sidebar */
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none;
        }

        .results-panel .card {
            border: none;
        }

        
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .coffee-icon {
            background: #8B4513;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 12px;
        }
        
        .search-marker {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        
        .nearest-marker {
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            font-size: 12px;
        }
        
        .radius-marker {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            font-size: 12px;
        }
        
        .shop-item {
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #e9ecef;
        }
        
        .shop-item:hover {
            background-color: #f8f9fa;
        }
        
        .shop-item:last-child {
            border-bottom: none;
        }
        
        .distance-badge {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
            font-weight: 600;
        }
        
        .rating {
            color: #ffc107;
        }
        
        .feature-icon {
            color: #6c757d;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .mode-selector {
            margin-bottom: 15px;
        }
        
        .mode-btn {
            margin-bottom: 10px;
        }
        /* Custom sidebar spacing (more generous than the second block) */
        .sidebar .control-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-coffee"></i> Dublin Coffee Finder
            </a>
            <div class="navbar-text text-white">
                <small id="shop-count">Loading...</small>
            </div>
        </div>
    </nav>

    <div class="wrapper">
        <div class="sidebar">
            <h5 class="mb-3"><i class="fas fa-search"></i> Search Coffee Shops</h5>
            
            <div class="mode-selector control-group">
                <label class="form-label"><strong>Select Search Mode:</strong></label>
                <select id="search-mode" class="form-select mb-3">
                    <option value="nearest">Find Nearest Shops</option>
                    <option value="radius">Search by Radius</option>
                    <option value="distance">Distance Between Shops</option>
                </select>
            </div>

            <div id="nearest-settings" class="search-settings control-group">
                <label class="form-label">Number of nearest shops:</label>
                <select id="limit-select" class="form-select mb-3">
                    <option value="3">3 nearest</option>
                    <option value="5" selected>5 nearest</option>
                    <option value="10">10 nearest</option>
                </select>
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle"></i> Click anywhere on the map to find nearest coffee shops
                </div>
            </div>

            <div id="radius-settings" class="search-settings control-group" style="display: none;">
                <label class="form-label">Search radius (km):</label>
                <input type="number" id="radius-km" class="form-control mb-3" 
                       value="2" min="0.5" max="20" step="0.5">
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle"></i> Click on the map to search within the radius
                </div>
            </div>

            <div id="distance-settings" class="search-settings control-group" style="display: none;">
                <div class="alert alert-warning py-2 small mb-3">
                    <i class="fas fa-info-circle"></i> Click on TWO coffee shop markers to measure distance between them
                </div>
                <div id="distance-result" class="alert alert-success" style="display: none;">
                    <strong>Distance:</strong>
                    <div id="distance-text"></div>
                </div>
            </div>

            <button id="clear-btn" class="btn btn-outline-secondary w-100 mt-3">
                <i class="fas fa-times"></i> Clear Results
            </button>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <div class="results-panel" id="results-panel">
                <div class="card border-0">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-list"></i> <span id="results-title">Results</span></h6>
                        <button id="close-results" class="btn-close btn-close-white"></button>
                    </div>
                    <div id="results-content" class="card-body p-0">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize map centered on Dublin
        const map = L.map('map').setView([53.3498, -6.2603], 13);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Layers
        const coffeeLayer = L.layerGroup().addTo(map);
        const searchLayer = L.layerGroup().addTo(map);
        
        let allCoffeeShops = [];
        let currentMode = 'nearest';
        let distanceModeShops = [];
        let radiusCircle = null;
        let distanceLine = null;
        
        // Load all coffee shops
        async function loadCoffeeShops() {
            try {
                const response = await fetch('/coffee/api/all/');
                const data = await response.json();
                
                allCoffeeShops = data.features;
                coffeeLayer.clearLayers();
                
                data.features.forEach(feature => {
                    addCoffeeMarker(feature);
                });
                
                document.getElementById('shop-count').textContent = 
                    `${data.features.length} coffee shops in Dublin`;
                    
            } catch (error) {
                console.error('Error loading coffee shops:', error);
                document.getElementById('shop-count').textContent = 'Error loading shops';
            }
        }
        
        function addCoffeeMarker(feature) {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            
            const icon = L.divIcon({
                className: 'coffee-marker',
                html: '<div class="coffee-icon"><i class="fas fa-mug-hot"></i></div>',
                iconSize: [25, 25],
                iconAnchor: [12.5, 12.5]
            });
            
            const marker = L.marker([coords[1], coords[0]], { icon: icon });
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <h6 class="mb-2"><i class="fas fa-coffee"></i> ${props.name}</h6>
                    <p class="mb-1 small"><i class="fas fa-map-marker-alt"></i> ${props.address}</p>
                    <p class="mb-1 small"><i class="fas fa-location-dot"></i> ${props.area}</p>
                    ${props.rating ? `<p class="mb-1 small"><i class="fas fa-star rating"></i> ${props.rating}/5</p>` : ''}
                    ${props.wifi ? '<span class="badge bg-info me-1"><i class="fas fa-wifi"></i> WiFi</span>' : ''}
                    ${props.outdoor_seating ? '<span class="badge bg-success"><i class="fas fa-tree"></i> Outdoor</span>' : ''}
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            // Add click handler for distance mode
            marker.on('click', function(e) {
                if (currentMode === 'distance') {
                    L.DomEvent.stopPropagation(e);
                    handleDistanceClick(props.id, props.name, coords);
                }
            });
            
            coffeeLayer.addLayer(marker);
        }
        
        // Handle mode change
        document.getElementById('search-mode').addEventListener('change', (e) => {
            currentMode = e.target.value;
            
            // Hide all settings
            document.getElementById('nearest-settings').style.display = 'none';
            document.getElementById('radius-settings').style.display = 'none';
            document.getElementById('distance-settings').style.display = 'none';
            
            // Show relevant settings
            if (currentMode === 'nearest') {
                document.getElementById('nearest-settings').style.display = 'block';
            } else if (currentMode === 'radius') {
                document.getElementById('radius-settings').style.display = 'block';
            } else if (currentMode === 'distance') {
                document.getElementById('distance-settings').style.display = 'block';
                distanceModeShops = [];
            }
            
            clearSearch();
        });
        
        // Map click handler
        map.on('click', (e) => {
            if (currentMode === 'nearest') {
                findNearest(e.latlng.lat, e.latlng.lng);
            } else if (currentMode === 'radius') {
                searchRadius(e.latlng.lat, e.latlng.lng);
            }
            // Distance mode handles clicks on markers, not map
        });
        
        // 1. Find nearest coffee shops
        async function findNearest(lat, lng) {
            const limit = document.getElementById('limit-select').value;
            
            try {
                const response = await fetch('/coffee/api/nearest/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ lat, lng, limit: parseInt(limit) })
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                displayNearestResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error finding nearest coffee shops. Please try again.');
            }
        }
        
        function displayNearestResults(data) {
            searchLayer.clearLayers();
            
            // Add search marker
            const searchMarker = L.marker(
                [data.search_point.lat, data.search_point.lng],
                {
                    icon: L.divIcon({
                        className: 'search-marker',
                        html: '<div class="search-marker"><i class="fas fa-location-dot"></i></div>',
                        iconSize: [35, 35],
                        iconAnchor: [17.5, 17.5]
                    })
                }
            );
            
            searchMarker.bindPopup(`
                <strong>Your Location</strong><br>
                ${data.search_point.lat.toFixed(4)}, ${data.search_point.lng.toFixed(4)}
            `).openPopup();
            
            searchLayer.addLayer(searchMarker);
            
            // Add numbered markers for nearest shops
            data.nearest_shops.forEach(shop => {
                const marker = L.marker(
                    [shop.coordinates.lat, shop.coordinates.lng],
                    {
                        icon: L.divIcon({
                            className: 'nearest-marker',
                            html: `<div class="nearest-marker">${shop.rank}</div>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    }
                );
                
                marker.bindPopup(`
                    <div style="min-width: 220px;">
                        <h6><span class="badge bg-success">#${shop.rank}</span> ${shop.name}</h6>
                        <p class="small mb-1">${shop.address}</p>
                        <p class="small"><strong>${shop.distance_km} km away</strong></p>
                    </div>
                `);
                
                searchLayer.addLayer(marker);
            });
            
            showResults(
                `${data.total_found} Nearest Coffee Shops`,
                data.nearest_shops.map(shop => ({
                    ...shop,
                    badge: `#${shop.rank}`,
                    badgeClass: 'bg-success'
                }))
            );
            
            // Fit map to show all results
            const allMarkers = searchLayer.getLayers();
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // 2. Search by radius
        async function searchRadius(lat, lng) {
            const radiusKm = parseFloat(document.getElementById('radius-km').value);
            
            if (isNaN(radiusKm) || radiusKm <= 0 || radiusKm > 20) {
                alert('Please enter a valid radius between 0.5 and 20 km');
                return;
            }
            
            try {
                const response = await fetch('/coffee/api/radius/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ lat, lng, radius_km: radiusKm })
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                displayRadiusResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error searching radius. Please try again.');
            }
        }
        
        function displayRadiusResults(data) {
            searchLayer.clearLayers();
            
            // Add center marker
            const centerMarker = L.marker(
                [data.search_point.lat, data.search_point.lng],
                {
                    icon: L.divIcon({
                        className: 'search-marker',
                        html: '<div class="search-marker"><i class="fas fa-bullseye"></i></div>',
                        iconSize: [35, 35],
                        iconAnchor: [17.5, 17.5]
                    })
                }
            );
            
            centerMarker.bindPopup(`
                <strong>Search Center</strong><br>
                Radius: ${data.radius_km} km
            `).openPopup();
            
            searchLayer.addLayer(centerMarker);
            
            // Draw circle
            radiusCircle = L.circle([data.search_point.lat, data.search_point.lng], {
                radius: data.radius_km * 1000,
                color: '#007bff',
                fillColor: '#007bff',
                fillOpacity: 0.1,
                weight: 2
            });
            
            searchLayer.addLayer(radiusCircle);
            
            // Add markers for shops in radius
            data.shops.forEach((shop, index) => {
                const marker = L.marker(
                    [shop.coordinates.lat, shop.coordinates.lng],
                    {
                        icon: L.divIcon({
                            className: 'radius-marker',
                            html: `<div class="radius-marker">${index + 1}</div>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    }
                );
                
                marker.bindPopup(`
                    <div style="min-width: 220px;">
                        <h6><span class="badge bg-primary">#${index + 1}</span> ${shop.name}</h6>
                        <p class="small mb-1">${shop.address}</p>
                        <p class="small"><strong>${shop.distance_km} km away</strong></p>
                    </div>
                `);
                
                searchLayer.addLayer(marker);
            });
            
            showResults(
                `${data.total_found} Shops in ${data.radius_km}km Radius`,
                data.shops.map((shop, index) => ({
                    ...shop,
                    badge: `#${index + 1}`,
                    badgeClass: 'bg-primary',
                    rank: index + 1
                }))
            );
            
            // Fit map to show circle
            if (radiusCircle) {
                map.fitBounds(radiusCircle.getBounds(), { padding: [50, 50] });
            }
        }
        
        // 3. Distance between shops
        function handleDistanceClick(shopId, shopName, coords) {
            distanceModeShops.push({ id: shopId, name: shopName, coords: coords });
            
            if (distanceModeShops.length === 1) {
                alert(`First shop selected: ${shopName}\n\nNow click on another coffee shop marker.`);
            } else if (distanceModeShops.length === 2) {
                calculateDistance();
            }
        }
        
        async function calculateDistance() {
            const shop1 = distanceModeShops[0];
            const shop2 = distanceModeShops[1];
            
            try {
                const response = await fetch(`/coffee/api/distance/${shop1.id}/${shop2.id}/`);
                
                if (!response.ok) throw new Error('Distance calculation failed');
                
                const data = await response.json();
                
                if (data.success) {
                    displayDistanceResult(data, shop1, shop2);
                } else {
                    alert('Error calculating distance: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error calculating distance. Please try again.');
            }
            
            // Reset
            distanceModeShops = [];
        }
        
        function displayDistanceResult(data, shop1, shop2) {
            searchLayer.clearLayers();
            
            // Draw line between shops
            distanceLine = L.polyline(
                [[shop1.coords[1], shop1.coords[0]], [shop2.coords[1], shop2.coords[0]]],
                { color: '#dc3545', weight: 3, dashArray: '10, 10' }
            );
            
            distanceLine.bindPopup(`<strong>Distance:</strong> ${data.distance.km} km`).openPopup();
            searchLayer.addLayer(distanceLine);
            
            // Show distance in panel
            const resultDiv = document.getElementById('distance-result');
            const textDiv = document.getElementById('distance-text');
            
            textDiv.innerHTML = `
                <strong>${shop1.name}</strong> to <strong>${shop2.name}</strong><br>
                üìè ${data.distance.km} km<br>
                üìè ${data.distance.meters} meters<br>
                üìè ${data.distance.miles} miles
            `;
            
            resultDiv.style.display = 'block';
            
            // Fit map to show both shops
            const bounds = L.latLngBounds([
                [shop1.coords[1], shop1.coords[0]],
                [shop2.coords[1], shop2.coords[0]]
            ]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // Show results in panel
        function showResults(title, shops) {
            const resultsPanel = document.getElementById('results-panel');
            const resultsTitle = document.getElementById('results-title');
            const resultsContent = document.getElementById('results-content');
            
            resultsTitle.textContent = title;
            
            resultsContent.innerHTML = shops.map(shop => `
                <div class="shop-item p-3" onclick="zoomToShop(${shop.coordinates.lat}, ${shop.coordinates.lng})">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge ${shop.badgeClass} me-2">${shop.badge}</span>
                                <strong>${shop.name}</strong>
                            </div>
                            <div class="small text-muted mb-1">
                                <i class="fas fa-map-marker-alt"></i> ${shop.address}
                            </div>
                            <div class="small text-muted">
                                <i class="fas fa-location-dot"></i> ${shop.area}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="distance-badge">
                                ${shop.distance_km} km
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            resultsPanel.style.display = 'block';
        }
        
        function zoomToShop(lat, lng) {
            map.setView([lat, lng], 16);
        }
        
        function clearSearch() {
            searchLayer.clearLayers();
            radiusCircle = null;
            distanceLine = null;
            distanceModeShops = [];
            document.getElementById('results-panel').style.display = 'none';
            document.getElementById('distance-result').style.display = 'none';
            map.setView([53.3498, -6.2603], 13);
        }
        
        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }
        
        // Event Listeners
        document.getElementById('clear-btn').addEventListener('click', clearSearch);
        document.getElementById('close-results').addEventListener('click', () => {
            document.getElementById('results-panel').style.display = 'none';
        });
        
        // Initialize
        loadCoffeeShops();
    </script>
</body>
</html>